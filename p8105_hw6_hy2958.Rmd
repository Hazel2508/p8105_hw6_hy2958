---
title: "p8105_hw6_hy2958"
output: github_document
date: "2025-11-30"
---

```{r}
library(tidyverse)
library(ggplot2)
library(modelr)
library(p8105.datasets)
```

```{r}
homicide = read_csv("./homicide-data.csv") %>% 
  mutate(city_state = str_c(city, ", ", state)) %>% 
  mutate(resolved = if_else(disposition == "Closed by arrest", 1, 0)) %>% 
  filter(!city_state %in% c("Dallas, TX",
  "Phoenix, AZ",
  "Kansas City, MO",
  "Tulsa, AL")) %>%
  filter(victim_race %in% c("White", "Black")) %>% 
  mutate(victim_age = as.numeric(victim_age)) %>% 
  filter(
    !is.na(victim_age),
    !is.na(victim_sex),
    !is.na(victim_race)) 
  

```

```{r}
#problem 1.1
baltimore <- homicide %>% 
  filter(city_state == "Baltimore, MD")

fit_baltimore <- glm(
resolved ~ victim_age + victim_sex + victim_race,
data = baltimore, family = binomial()
) %>% 
  broom::tidy(conf.int = TRUE)


fit_baltimore %>%
filter(term == "victim_sexMale") %>%
select(term, estimate, conf.low, conf.high) %>% 
knitr::kable()

```

```{r}
#1.2

  
safe_glm <- purrr::possibly(
  function(df)
    glm(resolved ~ victim_age + victim_sex + victim_race,
        data = df, family = binomial()),
  otherwise = NULL
)

safe_tidy <- function(model) {
  if (is.null(model)) {
    return(tibble(
      term = character(),
      estimate = numeric(),
      conf.low = numeric(),
      conf.high = numeric()
    ))
  } else {
    return(
      broom::tidy(model, conf.int = TRUE, exponentiate = TRUE)
    )
  }
}

city <- homicide %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    model = map(data, safe_glm),
    tidy_model = map(model, safe_tidy)
  )


or_ci_city <- city %>%
  select(city_state, tidy_model) %>%
  unnest(tidy_model) %>%
  filter(term == "victim_sexMale") %>% 
  select(city_state, estimate, conf.low, conf.high) %>%
  arrange(estimate) 

  knitr::kable(or_ci_city)
  
 

ggplot(or_ci_city, 
       aes(x = reorder(city_state, estimate), y = estimate)) +
  geom_point(size = 2, color = "steelblue") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = 0.15, color = "steelblue") +
  coord_flip() +
  labs(
    title = "Adjusted Odds Ratio (Male vs Female Victims) by City",
    x = "City",
    y = "Adjusted OR"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.y = element_text(size = 7),  
    plot.title  = element_text(size = 12)
  )


```
The plot shows substantial variation across cities in the adjusted odds ratio (OR) comparing the probability of solving homicides involving male versus female victims. In most cities, the OR is below 1, indicating that cases with male victims are less likely to be solved than those with female victims after adjusting for age and race. A few cities show ORs close to or above 1, but many of these have wide confidence intervals, suggesting limited precision. Overall, the results highlight consistent disparities in homicide resolution associated with victim sex across major U.S. cities.

```{r}
#problem 2

data("weather_df")

boot_fn <- function(df) {
  boot_sample <- sample_n(df, size = nrow(df), replace = TRUE)

  fit <- lm(tmax ~ tmin + prcp, data = boot_sample)

  r2      <- broom::glance(fit)$r.squared
  tidyfit <- broom::tidy(fit)

  beta1 <- tidyfit$estimate[tidyfit$term == "tmin"]
  beta2 <- tidyfit$estimate[tidyfit$term == "prcp"]

  ratio <- beta1 / beta2

  tibble(r2 = r2, ratio = ratio)
}

boot_results <- map_df(1:5000, ~ boot_fn(weather_df))

ci_r2 <- quantile(boot_results$r2, c(0.025, 0.975))
ci_ratio <- quantile(boot_results$ratio, c(0.025, 0.975))

ci_r2
ci_ratio

boot_results %>%
  ggplot(aes(x = r2)) +
  geom_histogram(bins = 40, fill = "skyblue", color = "white") +
  labs(title = "Bootstrap Distribution of R-squared")

boot_results %>%
  ggplot(aes(x = ratio)) +
  geom_histogram(bins = 40, fill = "tomato", color = "white") +
  labs(title = "Bootstrap Distribution of Beta1 / Beta2")

```

The bootstrap distribution of R^2 is concentrated and roughly symmetric, indicating that the model‚Äôs explanatory power is very stable across resampled datasets. In contrast, the distribution of the coefficient ratio 
ùõΩ^1/ùõΩ^2 is much wider and skewed, reflecting substantial uncertainty and variability in this quantity. This suggests that while the overall fit of the model is very consistent, the relative contribution of tmin versus prcp is much less stable.

```{r}
#problem 3
#data preparation
bw <- read_csv("./birthweight.csv") %>% 
  mutate(
   babysex = factor(babysex, 
                     levels = c(1, 2),
                     labels = c("male", "female")),
    
    frace = factor(frace,
                   levels = c(1, 2, 3, 4, 8, 9),
                   labels = c("White", "Black", "Asian", "PuertoRican", "Other", "Unknown")),
    
    mrace = factor(mrace,
                   levels = c(1, 2, 3, 4, 8),
                   labels = c("White", "Black", "Asian", "PuertoRican", "Other")),
    
    malform = factor(malform,
                     levels = c(0, 1),
                     labels = c("absent", "present"))
  )

```
```{r}
model_A1 <- lm(bwt ~ blength + gaweeks + ppbmi + smoken + babysex + parity,
              data = bw)
summary(model_A1)

model_A2 <- lm(
  bwt ~ blength + bhead + gaweeks + ppbmi + smoken + babysex +
    blength:bhead,
  data = bw
)
summary(model_A2)


```
At first, we choose the direct factors: blength, gaweeks, ppbmi, smoken, babysex, parity. Because birthweight strongly depends on fetal body size, the head circumference (bhead) and the blength √ó bhead interaction is added. This modification increased adjusted R¬≤ from 0.58 to 0.69, reduced residual error, and removed the residual curvature. The interaction term was highly significant, confirming that birthweight is better predicted by the joint relationship between length and head circumference rather than either measure alone.

```{r}
bw_predA <- bw %>% 
  add_predictions(model_A2) %>% 
  add_residuals(model_A2)

ggplot(bw_predA, aes(x = pred, y = resid)) +
  geom_point(alpha = 0.4) +
  geom_smooth(se = FALSE) +
  labs(title = "Residuals vs Fitted: Model A")
```

```{r}

model_B <- lm(bwt ~ blength + gaweeks, data = bw)
model_C <- lm(bwt ~ bhead * blength * babysex, data = bw)

set.seed(123)
cv <- modelr::crossv_mc(bw, 100)

cv <- cv %>%
  mutate(
    train = map(train, as_tibble),
    test  = map(test,  as_tibble),
  
    fit_A = map(train, ~ lm(bwt ~ blength + bhead + gaweeks + ppbmi + smoken + babysex + blength:bhead, data = .x)),
    fit_B = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
    fit_C = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x)),

    rmse_A = map2_dbl(fit_A, test, ~ rmse(model = .x, data = .y)),
    rmse_B = map2_dbl(fit_B, test, ~ rmse(model = .x, data = .y)),
    rmse_C = map2_dbl(fit_C, test, ~ rmse(model = .x, data = .y))
  )

```

```{r}
cv_rmse <- cv %>%
  select(starts_with("rmse")) %>%
  pivot_longer(everything(), names_to = "model", values_to = "rmse")

cv_rmse %>%
  ggplot(aes(x = model, y = rmse)) +
  geom_boxplot() +
  labs(title = "Cross-validated RMSE for the 3 models")

```
 Model A achieves the lowest RMSE, indicating the best performance. Model C performs slightly worse than Model A. Model B has the highest RMSE and the weakest predictive ability. Overall, the cross-validation results confirm that Model A provides the most accurate and reliable predictions of birthweight.
