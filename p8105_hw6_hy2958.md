p8105_hw6_hy2958
================
2025-11-30

``` r
library(tidyverse)
```

    ## â”€â”€ Attaching core tidyverse packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 2.0.0 â”€â”€
    ## âœ” dplyr     1.1.4     âœ” readr     2.1.5
    ## âœ” forcats   1.0.0     âœ” stringr   1.5.1
    ## âœ” ggplot2   3.5.2     âœ” tibble    3.3.0
    ## âœ” lubridate 1.9.4     âœ” tidyr     1.3.1
    ## âœ” purrr     1.1.0     
    ## â”€â”€ Conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
    ## âœ– dplyr::filter() masks stats::filter()
    ## âœ– dplyr::lag()    masks stats::lag()
    ## â„¹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(ggplot2)
library(modelr)
library(p8105.datasets)
```

``` r
homicide = read_csv("./homicide-data.csv") %>% 
  mutate(city_state = str_c(city, ", ", state)) %>% 
  mutate(resolved = if_else(disposition == "Closed by arrest", 1, 0)) %>% 
  filter(!city_state %in% c("Dallas, TX",
  "Phoenix, AZ",
  "Kansas City, MO",
  "Tulsa, AL")) %>%
  filter(victim_race %in% c("White", "Black")) %>% 
  mutate(victim_age = as.numeric(victim_age)) %>% 
  filter(
    !is.na(victim_age),
    !is.na(victim_sex),
    !is.na(victim_race)) 
```

    ## Rows: 52179 Columns: 12
    ## â”€â”€ Column specification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## â„¹ Use `spec()` to retrieve the full column specification for this data.
    ## â„¹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

    ## Warning: There was 1 warning in `mutate()`.
    ## â„¹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

``` r
#problem 1.1
baltimore <- homicide %>% 
  filter(city_state == "Baltimore, MD")

fit_baltimore <- glm(
resolved ~ victim_age + victim_sex + victim_race,
data = baltimore, family = binomial()
) %>% 
  broom::tidy(conf.int = TRUE)


fit_baltimore %>%
filter(term == "victim_sexMale") %>%
select(term, estimate, conf.low, conf.high) %>% 
knitr::kable()
```

| term           |   estimate |  conf.low |  conf.high |
|:---------------|-----------:|----------:|-----------:|
| victim_sexMale | -0.8544628 | -1.126423 | -0.5842017 |

``` r
#1.2

  
safe_glm <- purrr::possibly(
  function(df)
    glm(resolved ~ victim_age + victim_sex + victim_race,
        data = df, family = binomial()),
  otherwise = NULL
)

safe_tidy <- function(model) {
  if (is.null(model)) {
    return(tibble(
      term = character(),
      estimate = numeric(),
      conf.low = numeric(),
      conf.high = numeric()
    ))
  } else {
    return(
      broom::tidy(model, conf.int = TRUE, exponentiate = TRUE)
    )
  }
}

city <- homicide %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    model = map(data, safe_glm),
    tidy_model = map(model, safe_tidy)
  )
```

    ## Warning: There were 43 warnings in `mutate()`.
    ## The first warning was:
    ## â„¹ In argument: `tidy_model = map(model, safe_tidy)`.
    ## â„¹ In group 1: `city_state = "Albuquerque, NM"`.
    ## Caused by warning:
    ## ! glm.fit: fitted probabilities numerically 0 or 1 occurred
    ## â„¹ Run `dplyr::last_dplyr_warnings()` to see the 42 remaining warnings.

``` r
or_ci_city <- city %>%
  select(city_state, tidy_model) %>%
  unnest(tidy_model) %>%
  filter(term == "victim_sexMale") %>% 
  select(city_state, estimate, conf.low, conf.high) %>%
  arrange(estimate) 

  knitr::kable(or_ci_city)
```

| city_state         |  estimate |  conf.low | conf.high |
|:-------------------|----------:|----------:|----------:|
| New York, NY       | 0.2623978 | 0.1327512 | 0.4850117 |
| Baton Rouge, LA    | 0.3814393 | 0.2043481 | 0.6836343 |
| Omaha, NE          | 0.3824861 | 0.1988357 | 0.7109316 |
| Cincinnati, OH     | 0.3998277 | 0.2313767 | 0.6670456 |
| Chicago, IL        | 0.4100982 | 0.3361233 | 0.5008546 |
| Long Beach, CA     | 0.4102163 | 0.1427304 | 1.0241775 |
| San Diego, CA      | 0.4130248 | 0.1913527 | 0.8301847 |
| Baltimore, MD      | 0.4255117 | 0.3241908 | 0.5575508 |
| Pittsburgh, PA     | 0.4307528 | 0.2626022 | 0.6955518 |
| Denver, CO         | 0.4790620 | 0.2327380 | 0.9624974 |
| Louisville, KY     | 0.4905546 | 0.3014879 | 0.7836391 |
| Philadelphia, PA   | 0.4962756 | 0.3760120 | 0.6498797 |
| San Bernardino, CA | 0.5003444 | 0.1655367 | 1.4623977 |
| Miami, FL          | 0.5152379 | 0.3040214 | 0.8734480 |
| Buffalo, NY        | 0.5205704 | 0.2884416 | 0.9358300 |
| Columbus, OH       | 0.5324845 | 0.3770457 | 0.7479124 |
| Oakland, CA        | 0.5630819 | 0.3637421 | 0.8671086 |
| Detroit, MI        | 0.5823472 | 0.4619454 | 0.7335458 |
| New Orleans, LA    | 0.5849373 | 0.4218807 | 0.8121787 |
| San Francisco, CA  | 0.6075362 | 0.3116925 | 1.1551470 |
| Los Angeles, CA    | 0.6618816 | 0.4565014 | 0.9541036 |
| Sacramento, CA     | 0.6688418 | 0.3262733 | 1.3143888 |
| Fort Worth, TX     | 0.6689803 | 0.3935128 | 1.1211603 |
| Boston, MA         | 0.6739912 | 0.3534469 | 1.2768225 |
| Washington, DC     | 0.6901713 | 0.4653608 | 1.0122516 |
| St.Â Louis, MO      | 0.7031665 | 0.5298505 | 0.9319005 |
| San Antonio, TX    | 0.7046200 | 0.3928179 | 1.2382509 |
| Houston, TX        | 0.7110264 | 0.5569844 | 0.9057376 |
| Jacksonville, FL   | 0.7198144 | 0.5359236 | 0.9650986 |
| Memphis, TN        | 0.7232194 | 0.5261210 | 0.9835973 |
| Milwaukee, wI      | 0.7271327 | 0.4951325 | 1.0542297 |
| Tampa, FL          | 0.8077029 | 0.3395253 | 1.8598834 |
| Durham, NC         | 0.8123514 | 0.3824420 | 1.6580169 |
| Las Vegas, NV      | 0.8373078 | 0.6058830 | 1.1510854 |
| Savannah, GA       | 0.8669817 | 0.4185827 | 1.7802453 |
| Birmingham, AL     | 0.8700153 | 0.5713814 | 1.3138409 |
| Charlotte, NC      | 0.8838976 | 0.5507440 | 1.3905954 |
| Indianapolis, IN   | 0.9187284 | 0.6784616 | 1.2413059 |
| Minneapolis, MN    | 0.9469587 | 0.4759016 | 1.8809745 |
| Oklahoma City, OK  | 0.9740747 | 0.6228507 | 1.5199721 |
| Tulsa, OK          | 0.9757694 | 0.6090664 | 1.5439356 |
| Atlanta, GA        | 1.0000771 | 0.6803477 | 1.4582575 |
| Richmond, VA       | 1.0060520 | 0.4834671 | 1.9936248 |
| Nashville, TN      | 1.0342379 | 0.6807452 | 1.5559966 |
| Fresno, CA         | 1.3351647 | 0.5672553 | 3.0475080 |
| Stockton, CA       | 1.3517273 | 0.6256427 | 2.9941299 |
| Albuquerque, NM    | 1.7674995 | 0.8247081 | 3.7618600 |

``` r
ggplot(or_ci_city, 
       aes(x = reorder(city_state, estimate), y = estimate)) +
  geom_point(size = 2, color = "steelblue") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = 0.15, color = "steelblue") +
  coord_flip() +
  labs(
    title = "Adjusted Odds Ratio (Male vs Female Victims) by City",
    x = "City",
    y = "Adjusted OR"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.y = element_text(size = 7),  
    plot.title  = element_text(size = 12)
  )
```

![](p8105_hw6_hy2958_files/figure-gfm/unnamed-chunk-4-1.png)<!-- --> The
plot shows substantial variation across cities in the adjusted odds
ratio (OR) comparing the probability of solving homicides involving male
versus female victims. In most cities, the OR is below 1, indicating
that cases with male victims are less likely to be solved than those
with female victims after adjusting for age and race. A few cities show
ORs close to or above 1, but many of these have wide confidence
intervals, suggesting limited precision. Overall, the results highlight
consistent disparities in homicide resolution associated with victim sex
across major U.S. cities.

``` r
#problem 2

data("weather_df")

boot_fn <- function(df) {
  boot_sample <- sample_n(df, size = nrow(df), replace = TRUE)

  fit <- lm(tmax ~ tmin + prcp, data = boot_sample)

  r2      <- broom::glance(fit)$r.squared
  tidyfit <- broom::tidy(fit)

  beta1 <- tidyfit$estimate[tidyfit$term == "tmin"]
  beta2 <- tidyfit$estimate[tidyfit$term == "prcp"]

  ratio <- beta1 / beta2

  tibble(r2 = r2, ratio = ratio)
}

boot_results <- map_df(1:5000, ~ boot_fn(weather_df))

ci_r2 <- quantile(boot_results$r2, c(0.025, 0.975))
ci_ratio <- quantile(boot_results$ratio, c(0.025, 0.975))

ci_r2
```

    ##      2.5%     97.5% 
    ## 0.9343529 0.9468106

``` r
ci_ratio
```

    ##      2.5%     97.5% 
    ## -280.2851 -124.1833

``` r
boot_results %>%
  ggplot(aes(x = r2)) +
  geom_histogram(bins = 40, fill = "skyblue", color = "white") +
  labs(title = "Bootstrap Distribution of R-squared")
```

![](p8105_hw6_hy2958_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->

``` r
boot_results %>%
  ggplot(aes(x = ratio)) +
  geom_histogram(bins = 40, fill = "tomato", color = "white") +
  labs(title = "Bootstrap Distribution of Beta1 / Beta2")
```

![](p8105_hw6_hy2958_files/figure-gfm/unnamed-chunk-5-2.png)<!-- -->

The bootstrap distribution of R^2 is concentrated and roughly symmetric,
indicating that the modelâ€™s explanatory power is very stable across
resampled datasets. In contrast, the distribution of the coefficient
ratio ğ›½<sup>1/ğ›½</sup>2 is much wider and skewed, reflecting substantial
uncertainty and variability in this quantity. This suggests that while
the overall fit of the model is very consistent, the relative
contribution of tmin versus prcp is much less stable.

``` r
#problem 3
#data preparation
bw <- read_csv("./birthweight.csv") %>% 
  mutate(
   babysex = factor(babysex, 
                     levels = c(1, 2),
                     labels = c("male", "female")),
    
    frace = factor(frace,
                   levels = c(1, 2, 3, 4, 8, 9),
                   labels = c("White", "Black", "Asian", "PuertoRican", "Other", "Unknown")),
    
    mrace = factor(mrace,
                   levels = c(1, 2, 3, 4, 8),
                   labels = c("White", "Black", "Asian", "PuertoRican", "Other")),
    
    malform = factor(malform,
                     levels = c(0, 1),
                     labels = c("absent", "present"))
  )
```

    ## Rows: 4342 Columns: 20
    ## â”€â”€ Column specification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...
    ## 
    ## â„¹ Use `spec()` to retrieve the full column specification for this data.
    ## â„¹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
model_A <- lm(bwt ~ blength + gaweeks + ppbmi + smoken + babysex + parity,
              data = bw)
summary(model_A)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ blength + gaweeks + ppbmi + smoken + babysex + 
    ##     parity, data = bw)
    ## 
    ## Residuals:
    ##     Min      1Q  Median      3Q     Max 
    ## -1691.8  -216.9   -11.1   207.4  4102.9 
    ## 
    ## Coefficients:
    ##                 Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)   -4420.1223   102.4639 -43.138  < 2e-16 ***
    ## blength         126.8811     2.0085  63.173  < 2e-16 ***
    ## gaweeks          28.0424     1.7223  16.282  < 2e-16 ***
    ## ppbmi             6.3697     1.5869   4.014 6.07e-05 ***
    ## smoken           -2.6477     0.6832  -3.875 0.000108 ***
    ## babysexfemale   -21.0296    10.1604  -2.070 0.038533 *  
    ## parity          138.2741    49.0997   2.816 0.004882 ** 
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 331.8 on 4335 degrees of freedom
    ## Multiple R-squared:  0.581,  Adjusted R-squared:  0.5804 
    ## F-statistic:  1002 on 6 and 4335 DF,  p-value: < 2.2e-16

``` r
bw_predA <- bw %>% 
  add_predictions(model_A) %>% 
  add_residuals(model_A)

ggplot(bw_predA, aes(x = pred, y = resid)) +
  geom_point(alpha = 0.4) +
  geom_smooth(se = FALSE) +
  labs(title = "Residuals vs Fitted: Model A")
```

    ## `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'

![](p8105_hw6_hy2958_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->
